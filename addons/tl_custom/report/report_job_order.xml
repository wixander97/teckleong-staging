<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_job_order">
    <t t-foreach="docs" t-as="o">
      <t t-call="web.basic_layout">
        <div class="header">
          <link rel="stylesheet" href="/tl_custom/static/css/job_order_report.css"/>
          <div class="job-order-header">
            <div style="width:50%">
              <div style="font-size:1.4em"><b>JOB FORM : <t t-esc="o.name"/></b></div>
              <div><b>Issued By : </b><t t-esc="o.sale_order_id.user_id.name or ''"/></div>
              <div><b>Checked By : </b>-</div>
            </div>
            <div style="width:50%">
              <div style="font-size:1.5em">
                <b>Customer : </b>
                <t t-if="o.sale_order_id.partner_id.parent_id.name">
                  <t t-esc="o.sale_order_id.partner_id.parent_id.name"/>
                </t>
                <t t-else="">
                  <t t-esc="o.sale_order_id.partner_id.name"/>
                </t>
              </div>
              <div style="font-size:.8em;margin-bottom:20px">Page <span class="page"/> / <span class="topage"/></div>
            </div>
          </div>
        </div>

        <div class="page">
          <link rel="stylesheet" href="/tl_custom/static/css/job_order_report.css"/>

          <!-- Header summary -->
          <table class="table-head">
            <thead>
              <tr>
                <td>Delivery Order Ref</td>
                <td>Total Quantity</td>
                <td>Delivery On / By</td>
                <td>Job Form Date</td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <t t-if="o.do_id"><t t-esc="o.do_id.name"/></t>
                  <t t-else=""><t t-esc="o.do_id_stored.name"/></t>
                </td>
                <td>
                  <t t-set="total_quantity" t-value="sum(l.quantity for l in o.job_order_line_ids)"/>
                  <t t-esc="'%.2f' % (total_quantity or 0)"/>
                </td>
                <td>
                  <t t-if="o.do_id">
                    <t t-esc="o.do_id.scheduled_date" t-options='{"widget":"date","format":"dd/MM/yyyy"}'/>
                  </t>
                  <t t-else="">
                    <t t-esc="o.do_id_stored.scheduled_date" t-options='{"widget":"date","format":"dd/MM/yyyy"}'/>
                  </t>
                </td>
                <td><t t-esc="o.datetime" t-options='{"widget":"date","format":"dd/MM/yyyy"}'/></td>
              </tr>
            </tbody>
          </table>

          <!-- Items table -->
          <table class="table-product">
            <thead>
              <tr>
                <td>Item</td>
                <td>Dimensions</td>
                <td>Description</td>
                <td>S/N</td>
                <td>Quantity(To Cut)</td>
                <td>Location</td>
                <td>Quantity(Done)</td>
                <td>Marking(Balance)</td>
              </tr>
            </thead>
            <tbody>

          <t t-foreach="items" t-as="item" t-index="i">
              <tr style="font-weight:bold">
                  <td><t t-esc="i + 1"/></td>
                  <td class="text-left"><t t-esc="item['dimension']"/></td>
                  <td><t t-esc="item['description']"/></td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>
                    <t t-esc="'%.2f' % (item['total_done'] or 0)"/> <t t-esc="item['uom']"/>
                  </td>
                  <td><t t-esc="item.get('electrode_number') or ''"/></td>
                </tr>

                <!-- DETAIL CUTS -->
                <t t-foreach="item['cuts']" t-as="cut">
                  <tr style="font-size:.9em">
                    <td colspan="2" class="text-right">To take/cut :</td>
                    <td>
                      <t t-esc="cut['dimension']"/>
                      (<t t-esc="'%.2f' % (cut['cut_balance_stock_bc'] or 0)"/> <t t-esc="item['uom']"/>)
                    </td>
                    <td><t t-esc="cut['lot_name']"/></td>
                    <td><t t-esc="'%.2f' % (cut['used_qty'] or 0)"/> <t t-esc="item['uom']"/></td>
                    <td><t t-esc="cut['location_name']"/></td>
                    <td>-</td>
                    <td>
                      <!-- Balances per cut -->
                      <t t-foreach="cut['balances']" t-as="balance">
                        <t t-set="prod" t-value="request.env['product.product'].browse(balance['product_id'])"/>
                        <t t-esc="prod.name"/> 
                        <t t-if="prod.categ_id.is_have_width and prod.width == 0">
                          x <t t-esc="'%.2f' % (balance['width_balance'] or 0)"/><t t-esc="prod.dimension_uom_id.name"/>
                        </t>
                        <t t-if="prod.categ_id.is_have_length and prod.length == 0">
                          x <t t-esc="'%.2f' % (balance['length_balance'] or 0)"/><t t-esc="prod.dimension_uom_id.name"/>
                        </t>
                        <t t-if="prod.categ_id.is_have_kg and prod.kg == 0">
                          x <t t-esc="'%.2f' % (balance['kg_balance'] or 0)"/><t t-esc="prod.dimension_uom_id.name"/>
                        </t>
                        (<t t-esc="'%.0f' % (balance['quantity'] or 0)"/> <t t-esc="item['uom']"/>)<br/>
                      </t>
                      <!-- sisa balance stock dari material yang sama -->
                      <t t-esc="cut['dimension']"/>
                      (<t t-esc="'%.2f' % (cut['cut_balance_stock'] or 0)"/> <t t-esc="item['uom']"/>)
                    </td>
                  </tr>
                </t>
              </t>

            </tbody>
          </table>
        </div>
      </t>
    </t>
  </template>

  <!-- Paperformat -->
  <record id="paperformat_job_order_report" model="report.paperformat">
    <field name="name">Job Order</field>
    <field name="default" eval="True"/>
    <field name="format">A4</field>
    <field name="orientation">Landscape</field>
    <field name="margin_top">30</field>
    <field name="margin_bottom">20</field>
    <field name="margin_left">7</field>
    <field name="margin_right">7</field>
    <field name="dpi">90</field>
  </record>

  <!-- Report action -->
  <record id="action_report_job_order" model="ir.actions.report">
    <field name="name">Job Order</field>
    <field name="model">job.order</field>
    <field name="report_type">qweb-pdf</field>
    <field name="report_name">tl_custom.report_job_order</field>
    <field name="report_file">tl_custom.report_job_order</field>
    <field name="binding_model_id" ref="model_job_order"/>
    <field name="binding_type">report</field>
    <field name="paperformat_id" ref="tl_custom.paperformat_job_order_report"/>
  </record>
</odoo>
