# -*- coding: utf-8 -*-
#################################################################################
# Author      : Webkul Software Pvt. Ltd. (<https://webkul.com/>)
# Copyright(c): 2015-Present Webkul Software Pvt. Ltd.
# License URL : https://store.webkul.com/license.html/
# All Rights Reserved.
#
#
#
# This program is copyright property of the author mentioned above.
# You can`t redistribute it and/or modify it.
#
#
# You should have received a copy of the License along with this program.
# If not, see <https://store.webkul.com/license.html/>
#################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError, AccessError
from odoo import SUPERUSER_ID
import re
import time
import json
from datetime import datetime, timedelta, date
from dateutil.parser import parse

import logging
_logger = logging.getLogger(__name__)

class SaleOrder(models.Model):
    _inherit = "sale.order"

    def action_create_custom_po(self):
        print("Test")


    @api.onchange('validity_date')
    def _validity_date(self):
        for line in self:
            if line.validity_date == False:
               line.validity_date = (datetime.now()+timedelta(days=5))

    @api.model_create_multi
    def create(self,vals):
        for values in vals:
            date = values.get('commitment_date')
            if date == False:
                values['commitment_date'] = (datetime.now()+timedelta(days=5))
        return super(SaleOrder, self).create(vals)   

    @api.onchange('discount_overall')
    def _discount_overall(self):
        if self.order_line:
            for order_lines in self.order_line:
                order_lines.update({
                    'discount_overall':self.discount_overall,
                    })
            for order_lines in self.custom_dimension_line_ids:
                order_lines.update({
                    'discount_overall':self.discount_overall,
                    })  

    def action_confirm(self):
        job_order_line_ids = []

        for custom_line in self.custom_dimension_line_ids:
            product_name = custom_line.parent_product_id.name
            product_sku = ''
            
            if custom_line.parent_product_id.default_code:
                product_sku = custom_line.parent_product_id.default_code + '-'

            if custom_line.parent_product_id.width != custom_line.width:
                width_code = str(int(round(custom_line.width)))

                if not len(width_code) >= 4:
                    while len(width_code) != 4:
                        width_code = '0' + width_code

                product_name += " x " + str(custom_line.width) + "mm"

                product_sku += width_code     

            if custom_line.parent_product_id.length != custom_line.length:
                length_code = str(int(round(custom_line.length)))

                if not len(length_code) >= 4:
                    while len(length_code) != 4:
                        length_code = '0' + length_code

                product_name += " x " + str(custom_line.length) + "mm"

                product_sku += length_code

            if custom_line.parent_product_id.kg != custom_line.kg:
                kg_code = str(int(custom_line.kg * 1000))
                max_len = 4

                if len(str(int(custom_line.kg))) == 2:
                    max_len = 5

                if not len(kg_code) >= max_len:
                    while len(kg_code) != max_len:
                        kg_code = '0' + kg_code

                product_name += " x " + str(custom_line.kg) + "kg"

                product_sku += kg_code 

            product_id = custom_line.parent_product_id.id
            child_roduct = self.env['product.product'].search([
                ('default_code', '=', product_sku),
                ('parent_product_id', '=', custom_line.parent_product_id.id),
                ('width', '=', custom_line.width),
                ('length', '=', custom_line.length),
                ('kg', '=', custom_line.kg),
            ], limit=1)            
                
            if child_roduct:
                product = child_roduct
            else : 
                product = self.env['product.product'].create({
                    'name': product_name,
                    'default_code': product_sku,
                    'diameter': custom_line.diameter,
                    # 'height': custom_line.height,
                    'width': custom_line.width,
                    'thickness': custom_line.thickness,
                    'length': custom_line.length,
                    'kg': custom_line.kg,
                    # 'outer_diameter': custom_line.outer_diameter,
                    'across_flat': custom_line.across_flat,
                    # 'breadth': custom_line.breadth,
                    'mesh_number': custom_line.mesh_number,
                    'mesh_size': custom_line.mesh_size,
                    'hole_diameter': custom_line.hole_diameter,
                    # 'number': custom_line.number,
                    # 'opening_dimension': custom_line.opening_dimension,
                    # 'metric_number': custom_line.metric_number,
                    # 'size': custom_line.size,
                    'width_2': custom_line.width_2,
                    'pitch': custom_line.pitch,
                    'inner_diameter': custom_line.inner_diameter,

                    'dimension_uom_id': custom_line.dimension_uom_id.id,
                    'parent_product_id': custom_line.parent_product_id.id,
                    'uom_id': custom_line.product_uom_id.id,
                    'uom_po_id': custom_line.product_uom_id.id,
                    'detailed_type': 'product',
                    'tracking': 'lot',
                    'categ_id': custom_line.parent_product_id.categ_id.id,
                })
                
            if custom_line.is_parent_id:   
                job_order_line_ids.append((0, 0, {
                    # 'requested_height': custom_line.height,
                    'requested_width': custom_line.width,
                    'requested_length': custom_line.length,
                    'requested_thickness': custom_line.thickness,
                    'requested_diameter': custom_line.diameter,
                    'requested_kg': custom_line.kg,
                    'requested_across_flat': custom_line.across_flat ,
                    'requested_mesh_number': custom_line.mesh_number ,
                    'requested_mesh_size': custom_line.mesh_size ,
                    'requested_hole_diameter': custom_line.hole_diameter ,
                    'requested_width_2': custom_line.width_2 ,
                    'requested_pitch': custom_line.pitch ,
                    'requested_inner_diameter': custom_line.inner_diameter,
                    'product_uom_id': custom_line.dimension_uom_id.id,
                    'quantity': custom_line.quantity,
                    'product_id': product.id,
                    'receipt_location_id': self.warehouse_id.lot_stock_id.id,
                }))
            
            self.order_line.create({
                'product_id': product.id,
                'product_uom_qty': custom_line.quantity,
                'price_unit': custom_line.unit_price,
                'tax_id': custom_line.tax_ids._ids,
                'discount': custom_line.discount,
                'discount_overall': self.discount_overall,
                'discount':custom_line.discount,
                'order_id': self.id,
                'name': product.name,
                'product_uom': custom_line.product_uom_id.id,
                'notes': custom_line.notes,
                'electrode_number': custom_line.electrode_number,
                'batch_number': custom_line.batch_number,
            })    
                        
        job_order = False

        if len(job_order_line_ids) > 0 : 
            job_order = self.env['job.order'].create({
                'sale_order_id': self.id,
                'job_order_line_ids': job_order_line_ids,
                'location_id': self.warehouse_id.id,
                'datetime': self.date_order,
            })

        if job_order:
            job_order_cutting_ids = []

            for line in job_order.job_order_line_ids:
                product_arr = self.env['product.product'].search([
                    ('parent_product_id', '=', line.parent_product_id.id),
                    ('qty_available', '>', 0)
                ])

                if product_arr:
                    if line.is_have_width and line.is_have_length and line.parent_product_id.product_tmpl_id.width == 0 and line.parent_product_id.product_tmpl_id.length == 0:
                        # product_arr = product_arr.filtered(lambda x: x.length >= line.requested_length and x.width >= line.requested_width) + product_arr.filtered(lambda x: x.length >= line.requested_width and x.width >= line.requested_length)
                        
                        # stocks = self.env['stock.quant'].search([
                        #     ('product_id', 'in', product_arr._ids),
                        #     ('quantity', '>', 0),
                        #     ('on_hand', '=', True),
                        # ])

                        # lowest = line.requested_length
                        # highest = line.requested_width

                        # if line.requested_length > line.requested_width:
                        #     lowest = line.requested_width
                        #     highest = line.requested_length

                        # stocks_substitute = []

                        # for stock in stocks:
                        #     stocks_substitute.append({
                        #         'id': stock.id,
                        #         'product_length': stock.product_id.product_tmpl_id.length,
                        #         'product_width': stock.product_id.product_tmpl_id.width,
                        #         'quantity': stock.quantity,
                        #         'warehouse_id': stock.location_id.warehouse_id.id,
                        #         'product': stock.product_id.id,
                        #     })

                        # lowest_sum = lowest * lowest

                        # while lowest_sum > 0 and len(stocks_substitute) > 0:
                        #     stocks_substitute = sorted(list(filter(lambda x: x['product_length'] == line.requested_length, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: x['product_length'] >= length_sum, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: (x['product_length'] < length_sum and x['product_length'] > line.requested_length), stocks_substitute)), key=lambda x: x['id'])

                        #     if line.requested_length < line.requested_width:
                        #         stocks_substitute = sorted(list(filter(lambda x: x['product_width'] == line.requested_width, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: x['product_width'] >= width_sum, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: (x['product_width'] < width_sum and x['product_width'] > line.requested_width), stocks_substitute)), key=lambda x: x['id'])

                        #     selected_stock = stocks_substitute[0]
                        #     selected_stock_length = stocks_substitute[0]['product_length']
                        #     selected_stock_width = stocks_substitute[0]['product_width']
                        #     stocks_substitute[0]['quantity'] -= 1
                        #     done_quantity = 0

                        #     stock_lowest = selected_stock_length
                        #     stock_highest = selected_stock_width

                        #     if selected_stock_length > selected_stock_width:
                        #         stock_highest = selected_stock_length
                        #         stock_lowest = selected_stock_width

                        product_arr_filtered = product_arr.filtered(lambda x: x.length >= line.requested_length and x.width >= line.requested_width) + product_arr.filtered(lambda x: x.length >= line.requested_width and x.width >= line.requested_length)

                        stocks = self.env['stock.quant'].search([
                            ('product_id', 'in', product_arr_filtered._ids),
                            ('quantity', '>', 0),
                            ('on_hand', '=', True),
                        ])

                        quantity = line.quantity

                        lowest = line.requested_length
                        highest = line.requested_width

                        if line.requested_length > line.requested_width:
                            lowest = line.requested_width
                            highest = line.requested_length

                            stocks = stocks.sorted(key=lambda x:(x.product_id.product_tmpl_id.width, x.product_id.product_tmpl_id.id))

                        else:
                            stocks = stocks.sorted(key=lambda x:(x.product_id.product_tmpl_id.length, x.product_id.product_tmpl_id.id))

                        for stock in stocks:
                            if quantity > 0:
                                for i in range (int(stock.quantity)):
                                    if quantity > 0:
                                        stock_lowest = stock.product_id.length
                                        stock_highest = stock.product_id.width

                                        if stock.product_id.length > stock.product_id.width:
                                            stock_highest = stock.product_id.length
                                            stock_lowest = stock.product_id.width

                                        length_1_balance = 0
                                        width_1_balance = 0
                                        length_2_balance = 0
                                        width_2_balance = 0

                                        done_quantity = 0

                                        if stock_highest >= lowest and stock_lowest >= highest:
                                            while(stock_highest >= lowest and stock_lowest >= highest and quantity > 0):
                                                stock_highest -= lowest
                                                quantity -= 1
                                                done_quantity += 1

                                        elif stock_highest >= highest and stock_lowest >= lowest:
                                            while(stock_highest >= highest and stock_lowest >= lowest and quantity > 0):
                                                stock_highest -= highest
                                                quantity -= 1
                                                done_quantity += 1

                                        lowest = lowest * done_quantity

                                        if stock.product_id.length == lowest and stock.product_id.width >= highest:
                                            length_1_balance = stock.product_id.length 
                                            width_1_balance = stock.product_id.width - highest

                                            length_2_balance =  0
                                            width_2_balance = stock.product_id.width

                                        elif stock.product_id.width == lowest and stock.product_id.length >= highest:
                                            length_1_balance = stock.product_id.length  - highest
                                            width_1_balance = stock.product_id.width

                                            length_2_balance =  stock.product_id.length
                                            width_2_balance = 0

                                        elif stock.product_id.length == highest and stock.product_id.width >= lowest:
                                            length_1_balance = stock.product_id.length 
                                            width_1_balance = stock.product_id.width - lowest

                                            length_2_balance =  0
                                            width_2_balance = stock.product_id.width

                                        elif stock.product_id.width == highest and stock.product_id.length >= lowest:
                                            length_1_balance = stock.product_id.length - lowest
                                            width_1_balance = stock.product_id.width

                                            length_2_balance =  stock.product_id.length
                                            width_2_balance = 0

                                        elif (stock.product_id.length >= lowest and stock.product_id.width >= highest):
                                            length_1_balance = stock.product_id.length
                                            width_1_balance = stock.product_id.width - highest

                                            length_2_balance =  stock.product_id.length - lowest
                                            width_2_balance = stock.product_id.width - (stock.product_id.width - highest)

                                        elif (stock.product_id.width >= lowest and stock.product_id.length >= highest):
                                            length_1_balance = stock.product_id.length - highest
                                            width_1_balance = stock.product_id.width

                                            length_2_balance =  stock.product_id.length - (stock.product_id.width - highest)
                                            width_2_balance = stock.product_id.width - lowest 
                                            
                                        job_order_cutting_ids.append({
                                            'job_order_id_char': int(job_order.id),
                                            'job_order_line_id': line.id,
                                            'stock_quantity_id': stock.id,
                                            'done_quantity': done_quantity,
                                            'warehouse_id': stock.location_id.warehouse_id.id,

                                            'length_balance': length_1_balance,
                                            'width_balance': width_1_balance,
                                            # 'height_balance': stock.product_id.height,
                                            'diameter_balance': stock.product_id.diameter,
                                            'thickness_balance': stock.product_id.thickness,
                                            'kg_balance': stock.product_id.kg,
                                            'across_flat_balance': stock.product_id.across_flat ,
                                            'mesh_number_balance': stock.product_id.mesh_number ,
                                            'mesh_size_balance': stock.product_id.mesh_size ,
                                            'hole_diameter_balance': stock.product_id.hole_diameter ,
                                            'width_2_balance': stock.product_id.width_2 ,
                                            'pitch_balance': stock.product_id.pitch ,
                                            'inner_diameter_balance': stock.product_id.inner_diameter,

                                            'length_balance_2': length_2_balance,
                                            'width_balance_2': width_2_balance,
                                        })

                                    else:
                                        break;

                            else:
                                break

                    else:
                        if line.is_have_length and line.parent_product_id.product_tmpl_id.length == 0:
                            length_sum = line.requested_length * line.quantity
                            product_arr = product_arr.filtered(lambda x: x.length >= line.requested_length)
                            stocks = self.env['stock.quant'].search([
                                ('product_id', 'in', product_arr._ids),
                                ('quantity', '>', 0),
                                ('on_hand', '=', True),
                            ])

                            stocks_substitute = []

                            for stock in stocks:
                                stocks_substitute.append({
                                    'id': stock.id,
                                    'product_length': stock.product_id.product_tmpl_id.length,
                                    'quantity': stock.quantity,
                                    'warehouse_id': stock.location_id.warehouse_id.id,
                                    'product': stock.product_id.id,
                                })

                            while length_sum > 0 and len(stocks_substitute) > 0:
                                stocks_substitute = sorted(list(filter(lambda x: x['product_length'] == line.requested_length, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: x['product_length'] >= length_sum, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: (x['product_length'] < length_sum and x['product_length'] > line.requested_length), stocks_substitute)), key=lambda x: x['id'])
                                selected_stock = stocks_substitute[0]
                                selected_stock_length = stocks_substitute[0]['product_length']
                                stocks_substitute[0]['quantity'] -= 1
                                done_quantity = 0

                                while selected_stock_length >= line.requested_length and length_sum > 0:
                                    selected_stock_length -= line.requested_length
                                    length_sum -= line.requested_length
                                    done_quantity += 1

                                if done_quantity > 0:
                                    product = self.env['product.product'].browse(stocks_substitute[0]['product'])

                                    job_order_cutting_ids.append({
                                        'job_order_id_char': int(job_order.id),
                                        'job_order_line_id': line.id,
                                        'stock_quantity_id': selected_stock['id'],
                                        'done_quantity': done_quantity,
                                        'warehouse_id': selected_stock['warehouse_id'],

                                        'length_balance': selected_stock_length,
                                        'width_balance': product.width,
                                        'diameter_balance': product.diameter,
                                        'thickness_balance': product.thickness,
                                        'kg_balance': product.kg,
                                        'across_flat_balance': product.across_flat ,
                                        'mesh_number_balance': product.mesh_number ,
                                        'mesh_size_balance': product.mesh_size ,
                                        'hole_diameter_balance': product.hole_diameter ,
                                        'width_2_balance': product.width_2 ,
                                        'pitch_balance': product.pitch ,
                                        'inner_diameter_balance': product.inner_diameter,
                                    })

                                if stocks_substitute[0]['quantity'] < 1:
                                    del stocks_substitute[0]

                        elif line.is_have_width and line.parent_product_id.product_tmpl_id.width == 0:
                            width_sum = line.requested_width * line.quantity
                            product_arr = product_arr.filtered(lambda x: x.width >= line.requested_width)
                            stocks = self.env['stock.quant'].search([
                                ('product_id', 'in', product_arr._ids),
                                ('quantity', '>', 0),
                                ('on_hand', '=', True),
                            ])

                            stocks_substitute = []

                            for stock in stocks:
                                stocks_substitute.append({
                                    'id': stock.id,
                                    'product_width': stock.product_id.product_tmpl_id.width,
                                    'quantity': stock.quantity,
                                    'warehouse_id': stock.location_id.warehouse_id.id,
                                    'product': stock.product_id.id,
                                })

                            while width_sum > 0 and len(stocks_substitute) > 0:
                                stocks_substitute = sorted(list(filter(lambda x: x['product_width'] == line.requested_width, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: x['product_width'] >= width_sum, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: (x['product_width'] < width_sum and x['product_width'] > line.requested_width), stocks_substitute)), key=lambda x: x['id'])
                                selected_stock = stocks_substitute[0]
                                selected_stock_width = stocks_substitute[0]['product_width']
                                stocks_substitute[0]['quantity'] -= 1
                                done_quantity = 0

                                while selected_stock_width >= line.requested_width and width_sum > 0:
                                    selected_stock_width -= line.requested_width
                                    width_sum -= line.requested_width
                                    done_quantity += 1

                                if done_quantity > 0:
                                    product = self.env['product.product'].browse(stocks_substitute[0]['product'])

                                    job_order_cutting_ids.append({
                                        'job_order_id_char': int(job_order.id),
                                        'job_order_line_id': line.id,
                                        'stock_quantity_id': selected_stock['id'],
                                        'done_quantity': done_quantity,
                                        'warehouse_id': selected_stock['warehouse_id'],

                                        'length_balance': product.length,
                                        'width_balance': selected_stock_width,
                                        'diameter_balance': product.diameter,
                                        'thickness_balance': product.thickness,
                                        'kg_balance': product.kg,
                                        'across_flat_balance': product.across_flat ,
                                        'mesh_number_balance': product.mesh_number ,
                                        'mesh_size_balance': product.mesh_size ,
                                        'hole_diameter_balance': product.hole_diameter ,
                                        'width_2_balance': product.width_2 ,
                                        'pitch_balance': product.pitch ,
                                        'inner_diameter_balance': product.inner_diameter,
                                    })

                                if stocks_substitute[0]['quantity'] < 1:
                                    del stocks_substitute[0]

                        elif line.is_have_kg and line.parent_product_id.product_tmpl_id.kg == 0:
                            kg_sum = line.requested_kg * line.quantity
                            product_arr = product_arr.filtered(lambda x: x.kg >= line.requested_kg)
                            stocks = self.env['stock.quant'].search([
                                ('product_id', 'in', product_arr._ids),
                                ('quantity', '>', 0),
                                ('on_hand', '=', True),
                            ])

                            stocks_substitute = []

                            for stock in stocks:
                                stocks_substitute.append({
                                    'id': stock.id,
                                    'product_kg': stock.product_id.product_tmpl_id.kg,
                                    'quantity': stock.quantity,
                                    'warehouse_id': stock.location_id.warehouse_id.id,
                                    'product': stock.product_id.id,
                                })

                            while kg_sum > 0 and len(stocks_substitute) > 0:
                                stocks_substitute = sorted(list(filter(lambda x: x['product_kg'] == line.requested_kg, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: x['product_kg'] >= kg_sum, stocks_substitute)), key=lambda x: x['id']) + sorted(list(filter(lambda x: (x['product_kg'] < kg_sum and x['product_kg'] > line.requested_kg), stocks_substitute)), key=lambda x: x['id'])
                                selected_stock = stocks_substitute[0]
                                selected_stock_kg = stocks_substitute[0]['product_kg']
                                stocks_substitute[0]['quantity'] -= 1
                                done_quantity = 0

                                while selected_stock_kg >= line.requested_kg and kg_sum > 0:
                                    selected_stock_kg -= line.requested_kg
                                    kg_sum -= line.requested_kg
                                    done_quantity += 1

                                if done_quantity > 0:
                                    product = self.env['product.product'].browse(stocks_substitute[0]['product'])

                                    job_order_cutting_ids.append({
                                        'job_order_id_char': int(job_order.id),
                                        'job_order_line_id': line.id,
                                        'stock_quantity_id': selected_stock['id'],
                                        'done_quantity': done_quantity,
                                        'warehouse_id': selected_stock['warehouse_id'],

                                        'length_balance': product.length,
                                        'width_balance': product.width,
                                        'diameter_balance': product.diameter,
                                        'thickness_balance': product.thickness,
                                        'kg_balance': selected_stock_kg,
                                        'across_flat_balance': product.across_flat ,
                                        'mesh_number_balance': product.mesh_number ,
                                        'mesh_size_balance': product.mesh_size ,
                                        'hole_diameter_balance': product.hole_diameter ,
                                        'width_2_balance': product.width_2 ,
                                        'pitch_balance': product.pitch ,
                                        'inner_diameter_balance': product.inner_diameter,
                                    })

                                if stocks_substitute[0]['quantity'] < 1:
                                    del stocks_substitute[0]

            multi_location = False
            locations = []

            # for job in job_order_cutting_ids:
            #     if job['warehouse_id'] != self.warehouse_id.id:
            #         multi_location = True
            #         break;

            for job in job_order_cutting_ids:
                if job['warehouse_id'] not in locations:
                    locations.append(job['warehouse_id'])

            if len(locations) == 1:
                if locations[0] != self.warehouse_id.id:
                    self.warehouse_id = locations[0]
            elif len(locations) > 1:
                multi_location = True

            if not multi_location:
                for job in job_order_cutting_ids:
                    balance_ids = []

                    if job['length_balance'] > 0 or job['width_balance'] > 0 or job['kg_balance'] > 0:
                        balance_ids.append((0, 0, {
                            'length_balance': job['length_balance'],
                            # 'height_balance': job['height_balance'],
                            'width_balance': job['width_balance'],
                            'diameter_balance': job['diameter_balance'],
                            'thickness_balance': job['thickness_balance'],
                            'kg_balance': job['kg_balance'],
                            'across_flat_balance': job['across_flat_balance'] ,
                            'mesh_number_balance': job['mesh_number_balance'] ,
                            'mesh_size_balance': job['mesh_size_balance'] ,
                            'hole_diameter_balance': job['hole_diameter_balance'] ,
                            'width_2_balance': job['width_2_balance'] ,
                            'pitch_balance': job['pitch_balance'] ,
                            'inner_diameter_balance': job['inner_diameter_balance'] ,
                        }))

                    if job.get('length_balance_2'):
                        if job['length_balance_2'] > 0 and job['width_balance_2'] > 0:
                            balance_ids.append((0, 0, {
                                'length_balance': job['length_balance_2'],
                                # 'height_balance': job['height_balance'],
                                'width_balance': job['width_balance_2'],
                                'diameter_balance': job['diameter_balance'],
                                'thickness_balance': job['thickness_balance'],
                                'kg_balance': job['kg_balance'],
                                'across_flat_balance': job['across_flat_balance'] ,
                                'mesh_number_balance': job['mesh_number_balance'] ,
                                'mesh_size_balance': job['mesh_size_balance'] ,
                                'hole_diameter_balance': job['hole_diameter_balance'] ,
                                'width_2_balance': job['width_2_balance'] ,
                                'pitch_balance': job['pitch_balance'] ,
                                'inner_diameter_balance': job['inner_diameter_balance'] ,

                            }))

                    job_order.job_order_cutting_ids = [(0, 0, {
                        'stock_quantity_id': job['stock_quantity_id'],
                        'line_ids': [(0, 0, {
                            'job_order_line_id': job['job_order_line_id'],
                            'done_quantity': job['done_quantity'],
                        })],
                        'balance_ids': balance_ids
                    })]

                    job_order.location_id = self.warehouse_id

                    for line in job_order.job_order_line_ids:
                        line.receipt_location_id = self.warehouse_id.lot_stock_id.id

            else:
                job_order.type = 'multiple_location'

                for line in job_order.job_order_line_ids:
                    for job in job_order_cutting_ids:
                        if line.id == job['job_order_line_id']:
                            line.location_id = job['warehouse_id']
                            break;

                job_order.action_confirm()

                for child in job_order.job_order_child_ids:
                    for job in job_order_cutting_ids:
                        if child.job_order_line_id.id == job['job_order_line_id']:
                            balance_ids = []

                            if job['length_balance'] > 0 or job['width_balance'] > 0 or job['kg_balance'] > 0:
                                balance_ids.append((0, 0, {
                                    'length_balance': job['length_balance'],
                                    # 'height_balance': job['height_balance'],
                                    'width_balance': job['width_balance'],
                                    'diameter_balance': job['diameter_balance'],
                                    'thickness_balance': job['thickness_balance'],
                                    'kg_balance': job['kg_balance'],
                                    'across_flat_balance': job['across_flat_balance'] ,
                                    'mesh_number_balance': job['mesh_number_balance'] ,
                                    'mesh_size_balance': job['mesh_size_balance'] ,
                                    'hole_diameter_balance': job['hole_diameter_balance'] ,
                                    'width_2_balance': job['width_2_balance'] ,
                                    'pitch_balance': job['pitch_balance'] ,
                                    'inner_diameter_balance': job['inner_diameter_balance'] ,

                                }))

                            if job.get('length_balance_2'):
                                if job['length_balance_2'] > 0 and job['width_balance_2'] > 0:
                                    balance_ids.append((0, 0, {
                                        'length_balance': job['length_balance_2'],
                                        # 'height_balance': job['height_balance'],
                                        'width_balance': job['width_balance_2'],
                                        'diameter_balance': job['diameter_balance'],
                                        'thickness_balance': job['thickness_balance'],
                                        'kg_balance': job['kg_balance'],
                                        'across_flat_balance': job['across_flat_balance'] ,
                                        'mesh_number_balance': job['mesh_number_balance'] ,
                                        'mesh_size_balance': job['mesh_size_balance'] ,
                                        'hole_diameter_balance': job['hole_diameter_balance'] ,
                                        'width_2_balance': job['width_2_balance'] ,
                                        'pitch_balance': job['pitch_balance'] ,
                                        'inner_diameter_balance': job['inner_diameter_balance'] ,
                                    }))

                            child.job_order_cutting_ids = [(0, 0, {
                                'stock_quantity_id': job['stock_quantity_id'],
                                'line_ids': [(0, 0, {
                                    'job_order_line_id': job['job_order_line_id'],
                                    'done_quantity': job['done_quantity'],
                                })],
                                'balance_ids': balance_ids
                            })]

                            break;

        res = super(SaleOrder, self).action_confirm()

        return res

    def action_view_job_order(self):
        self.ensure_one()

        return {
            'name': 'Job Order',
            'type': 'ir.actions.act_window',
            'view_mode': 'tree,form',
            'res_model': 'job.order',
            'domain': [('sale_order_id', '=', self.id)],
            'target': 'current',
        }

    def action_view_purchase(self):
        self.ensure_one()

        return {
            'name': 'Purchase',
            'type': 'ir.actions.act_window',
            'view_mode': 'tree,form',
            'res_model': 'purchase.order',
            'domain': [('sale_order_id', '=', self.id)],
            'target': 'current',
        }

    @api.depends('custom_dimension_line_ids.price_total')
    def _amount_all_custom(self):
        """
        Compute the total amounts of the SO.
        """
        for order in self:
            amount_untaxed = amount_tax = 0.0
            for line in order.custom_dimension_line_ids:
                amount_untaxed += line.subtotal
                amount_tax += line.price_tax
            order.update({
                'custom_amount_untaxed': amount_untaxed,
                'custom_amount_tax': amount_tax,
                'custom_amount_total': amount_untaxed + amount_tax,
            })
    @api.depends('custom_dimension_line_ids.tax_ids', 'custom_dimension_line_ids.unit_price','custom_amount_tax','custom_amount_total')
    def _compute_tax_totals_json2(self):
        def compute_taxes1(custom_dimension_line_ids):
            order_line = custom_dimension_line_ids
            price = order_line.unit_price * (1 - (order_line.discount or 0.0) / 100.0)
            order = order_line.id
            return order_line.tax_ids._origin.compute_all(price, self.currency_id, order_line.quantity, product=order_line.parent_product_id, partner=self.partner_shipping_id)
        
        account_move = self.env['account.move']
        for order in self:
            tax_lines_data = account_move._prepare_tax_lines_data_for_totals_from_object(order.custom_dimension_line_ids, compute_taxes1)
            tax_totals = account_move._get_tax_totals(order.partner_id,tax_lines_data, order.custom_amount_total, order.custom_amount_untaxed, order.currency_id)
            
            order.tax_totals_json2 = json.dumps(tax_totals)
    
    
    custom_amount_untaxed = fields.Monetary(string='Untaxed Amount', store=True, compute='_amount_all_custom', tracking=5)
    custom_amount_tax = fields.Monetary(string='Taxes', store=True, compute='_amount_all_custom')
    custom_amount_total = fields.Monetary(string='Total', store=True, compute='_amount_all_custom', tracking=4)
    po_ref = fields.Char('PO Ref')
    custom_dimension_line_ids = fields.One2many('sale.order.custom.dimension.line', 'order_ids', string='Custom Dimension Line')
    job_order_ids = fields.One2many('job.order', 'sale_order_id', string='Job Order')
    is_subcontractor = fields.Boolean('Subcontractor')
    discount_overall = fields.Float('Overall Discount %')
    tax_totals_json2 = fields.Char(compute='_compute_tax_totals_json2')
    remarks = fields.Text('Remarks')

class SaleOrderLine(models.Model):
    _inherit = 'sale.order.line'

    @api.depends('product_uom_qty', 'discount', 'price_unit', 'tax_id','discount_overall')
    def _compute_amount(self):
        """
        Compute the amounts of the SO line.
        """
        for line in self:
            sumdis = line.discount + line.discount_overall
            price = line.price_unit * (1 - (sumdis  or 0.0) / 100.0)
            
            taxes = line.tax_id.compute_all(price, line.order_id.currency_id, line.product_uom_qty, product=line.product_id, partner=line.order_id.partner_shipping_id)
            line.update({
                'price_tax': taxes['total_included'] - taxes['total_excluded'],
                'price_total': taxes['total_included'],
                'price_subtotal': taxes['total_excluded'],
            })
            if self.env.context.get('import_file', False) and not self.env.user.user_has_groups('account.group_account_manager'):
                line.tax_id.invalidate_cache(['invoice_repartition_line_ids'], [line.tax_id.id])
                
    electrode_number = fields.Char('Electrode Number')
    batch_number = fields.Char('Batch Number')
    discount_overall = fields.Float('Overall Discount %')
    notes = fields.Text('Notes')


class SaleOrderCustomDimensionLine(models.Model):
    _name = "sale.order.custom.dimension.line"
    _description = "Sale Order Custom Dimension Line"
    
    @api.depends('quantity', 'discount', 'unit_price', 'tax_ids','discount_overall')
    def _compute_amount(self):
        """
        Compute the amounts of the SO line.
        """
        for line in self:
            sumdis = line.discount + line.discount_overall
            price = line.unit_price * (1 - (sumdis  or 0.0) / 100.0)
            
            taxes = line.tax_ids.compute_all(price, line.order_ids.currency_id, line.quantity, product=line.parent_product_id, partner=line.order_ids.partner_shipping_id)
            line.update({
                'price_tax': taxes['total_included'] - taxes['total_excluded'],
                'price_total': taxes['total_included'],
                'subtotal': taxes['total_excluded'],
            })
            if self.env.context.get('import_file', False) and not self.env.user.user_has_groups('account.group_account_manager'):
                line.tax_ids.invalidate_cache(['invoice_repartition_line_ids'], [line.tax_ids.id])

    @api.onchange('parent_product_id')
    def onchange_parent_product_id(self):
        self.diameter = self.parent_product_id.product_tmpl_id.diameter
        self.thickness = self.parent_product_id.product_tmpl_id.thickness
        self.width = self.parent_product_id.product_tmpl_id.width
        self.length = self.parent_product_id.product_tmpl_id.length
        # self.height = self.parent_product_id.product_tmpl_id.height
        self.kg = self.parent_product_id.product_tmpl_id.kg
        # self.outer_diameter = self.parent_product_id.product_tmpl_id.outer_diameter
        self.across_flat = self.parent_product_id.product_tmpl_id.across_flat
        # self.breadth = self.parent_product_id.product_tmpl_id.breadth
        self.mesh_number = self.parent_product_id.product_tmpl_id.mesh_number
        self.mesh_size = self.parent_product_id.product_tmpl_id.mesh_size
        self.hole_diameter = self.parent_product_id.product_tmpl_id.hole_diameter
        # self.number = self.parent_product_id.product_tmpl_id.number
        # self.opening_dimension = self.parent_product_id.product_tmpl_id.opening_dimension
        # self.metric_number = self.parent_product_id.product_tmpl_id.metric_number
        # self.size = self.parent_product_id.product_tmpl_id.size
        self.width_2 = self.parent_product_id.product_tmpl_id.width_2
        self.pitch = self.parent_product_id.product_tmpl_id.pitch
        self.inner_diameter = self.parent_product_id.product_tmpl_id.inner_diameter

        self.tax_ids = self.parent_product_id.product_tmpl_id.taxes_id
        self.product_uom_id = self.parent_product_id.product_tmpl_id.uom_id
        self.unit_price = self.parent_product_id.product_tmpl_id.list_price
        self.description = self.parent_product_id.product_tmpl_id.name
        self.dimension_uom_id = self.parent_product_id.product_tmpl_id.dimension_uom_id
        self.is_parent_id = self.parent_product_id.product_tmpl_id.is_parent_product
        self.is_have_diameter = self.parent_product_id.product_tmpl_id.categ_id.is_have_diameter
        # self.is_have_height = self.parent_product_id.product_tmpl_id.categ_id.is_have_height
        self.is_have_width = self.parent_product_id.product_tmpl_id.categ_id.is_have_width
        self.is_have_thickness = self.parent_product_id.product_tmpl_id.categ_id.is_have_thickness
        self.is_have_length = self.parent_product_id.product_tmpl_id.categ_id.is_have_length
        self.is_have_kg = self.parent_product_id.product_tmpl_id.categ_id.is_have_kg

        # self.is_have_outer_diameter = self.parent_product_id.product_tmpl_id.categ_id.is_have_outer_diameter
        self.is_have_across_flat = self.parent_product_id.product_tmpl_id.categ_id.is_have_across_flat
        # self.is_have_breadth = self.parent_product_id.product_tmpl_id.categ_id.is_have_breadth
        self.is_have_mesh_number = self.parent_product_id.product_tmpl_id.categ_id.is_have_mesh_number
        self.is_have_mesh_size = self.parent_product_id.product_tmpl_id.categ_id.is_have_mesh_size
        self.is_have_hole_diameter = self.parent_product_id.product_tmpl_id.categ_id.is_have_hole_diameter
        # self.is_have_number = self.parent_product_id.product_tmpl_id.categ_id.is_have_number
        # self.is_have_opening_dimension = self.parent_product_id.product_tmpl_id.categ_id.is_have_opening_dimension
        # self.is_have_metric_number = self.parent_product_id.product_tmpl_id.categ_id.is_have_metric_number
        # self.is_have_size = self.parent_product_id.product_tmpl_id.categ_id.is_have_size
        self.is_have_width_2 = self.parent_product_id.product_tmpl_id.categ_id.is_have_width_2
        self.is_have_pitch = self.parent_product_id.product_tmpl_id.categ_id.is_have_pitch
        self.is_have_inner_diameter = self.parent_product_id.product_tmpl_id.categ_id.is_have_inner_diameter

        self.master_width = self.parent_product_id.product_tmpl_id.width
        self.master_length = self.parent_product_id.product_tmpl_id.length
        # self.master_height = self.parent_product_id.product_tmpl_id.height
        self.master_diameter = self.parent_product_id.product_tmpl_id.diameter
        self.master_thickness = self.parent_product_id.product_tmpl_id.thickness
        self.master_kg = self.parent_product_id.product_tmpl_id.kg
        # self.master_outer_diameter  = self.parent_product_id.product_tmpl_id.outer_diameter
        self.master_across_flat = self.parent_product_id.product_tmpl_id.across_flat
        # self.master_breadth = self.parent_product_id.product_tmpl_id.breadth
        self.master_mesh_number = self.parent_product_id.product_tmpl_id.mesh_number
        self.master_mesh_size = self.parent_product_id.product_tmpl_id.mesh_size
        self.master_hole_diameter = self.parent_product_id.product_tmpl_id.hole_diameter
        # self.master_number = self.parent_product_id.product_tmpl_id.number
        # self.master_opening_dimension = self.parent_product_id.product_tmpl_id.opening_dimension
        # self.master_metric_number = self.parent_product_id.product_tmpl_id.metric_number
        # self.master_size = self.parent_product_id.product_tmpl_id.size
        self.master_width_2 = self.parent_product_id.product_tmpl_id.width_2
        self.master_pitch = self.parent_product_id.product_tmpl_id.pitch
        self.master_inner_diameter = self.parent_product_id.product_tmpl_id.inner_diameter

    @api.depends('tax_ids')
    def _compute_tax_price(self):
        for line in self:
            tax_price = 0

            for tax in line.tax_ids:
                tax_price += line.unit_price * tax.amount / 100 * line.quantity

            line.tax_price = tax_price

    @api.depends('parent_product_id','width','length','kg')
    def _compute_child_product(self):
        for line in self:
            product_name = line.name

            if line.parent_product_id.width != line.width:
                product_name += " x " + "(W)"+str((line.width))+ "mm"

            
            if line.parent_product_id.length != line.length:
                product_name += " x " + "(L)"+ str((line.length))+"mm"

            
            if line.parent_product_id.kg != line.kg:
                product_name += " x " + "(KG)"+str(line.kg)+ "kg"

            line.child_product = product_name

    @api.onchange('diameter')
    def onchange_diameter(self):
        if self.is_parent_id:
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_diameter:
                    if self.parent_product_id.product_tmpl_id.diameter > 0 and self.parent_product_id.product_tmpl_id.diameter != self.diameter:
                        self.diameter = 0
                        raise ValidationError("You Cannot change this Product Diameter.")
                else:
                    self.diameter = 0
                    # raise ValidationError("This Product doesn't have Diameter.")

    # @api.onchange('height')
    # def onchange_height(self):
    #     if self.is_parent_id:
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_height:
    #                 if self.parent_product_id.product_tmpl_id.height > 0 and self.parent_product_id.product_tmpl_id.height != self.height:
    #                     self.height = 0
    #                     raise ValidationError("You Cannot change this Product Height.")
    #             else:
    #                 self.height = 0
    #                 # raise ValidationError("This Product doesn't have Height.")

    @api.onchange('width')
    def onchange_width(self):
        if self.is_parent_id:
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_width:
                    if self.parent_product_id.product_tmpl_id.width > 0 and self.parent_product_id.product_tmpl_id.width != self.width:
                        self.width = 0
                        raise ValidationError("You Cannot change this Product Width.")
                else:
                    self.width = 0
                    # raise ValidationError("This Product doesn't have Width.")

    @api.onchange('thickness')
    def onchange_thickness(self):
        if self.is_parent_id:
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_thickness:
                    if self.parent_product_id.product_tmpl_id.thickness > 0 and self.parent_product_id.product_tmpl_id.thickness != self.thickness:
                        self.thickness = 0
                        raise ValidationError("You Cannot change this Product Thickness.")
                else:
                    self.thickness = 0
                    # raise ValidationError("This Product doesn't have Thickness.")

    @api.onchange('length')
    def onchange_length(self):
        if self.is_parent_id:
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_length:
                    if self.parent_product_id.product_tmpl_id.length > 0 and self.parent_product_id.product_tmpl_id.length != self.length:
                        self.length = 0
                        raise ValidationError("You Cannot change this Product Length.")
                else:
                    self.length = 0
                    # raise ValidationError("This Product doesn't have Length.")

    @api.onchange('kg')
    def onchange_kg(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_kg:
                    if self.parent_product_id.product_tmpl_id.kg > 0 and self.parent_product_id.product_tmpl_id.kg != self.kg:
                        self.kg = 0
                        raise ValidationError("You Cannot change this Product kg.")
                else:
                    self.kg = 0
                    # raise ValidationError("This Product doesn't have kg.")
    
    # @api.onchange('outer_diameter')
    # def onchange_outer_diameter(self):
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_outer_diameter:
    #                 if self.parent_product_id.product_tmpl_id.outer_diameter > 0 and self.parent_product_id.product_tmpl_id.outer_diameter != self.outer_diameter:
    #                     self.outer_diameter = 0
    #                     raise ValidationError("You Cannot change this Product outer diameter.")
    #             else:
    #                 self.outer_diameter = 0
    #                 # raise ValidationError("This Product doesn't have kg.")
    
    @api.onchange('across_flat')
    def onchange_across_flat(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_across_flat:
                    if self.parent_product_id.product_tmpl_id.across_flat > 0 and self.parent_product_id.product_tmpl_id.across_flat != self.across_flat:
                        self.across_flat = 0
                        raise ValidationError("You Cannot change this Product across flat.")
                else:
                    self.across_flat = 0
                    # raise ValidationError("This Product doesn't have across flat.")

    # @api.onchange('breadth')
    # def onchange_breadth(self):
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_breadth:
    #                 if self.parent_product_id.product_tmpl_id.breadth > 0 and self.parent_product_id.product_tmpl_id.breadth != self.breadth:
    #                     self.breadth = 0
    #                     raise ValidationError("You Cannot change this Product breadth.")
    #             else:
    #                 self.breadth = 0
    #                 # raise ValidationError("This Product doesn't have kg.")
    
    @api.onchange('mesh_number')
    def onchange_mesh_number(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_mesh_number:
                    if self.parent_product_id.product_tmpl_id.mesh_number > 0 and self.parent_product_id.product_tmpl_id.mesh_number != self.mesh_number:
                        self.mesh_number = 0
                        raise ValidationError("You Cannot change this Product mesh number.")
                else:
                    self.mesh_number = 0
                    # raise ValidationError("This Product doesn't have kg.")
    
    @api.onchange('mesh_size')
    def onchange_mesh_size(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_mesh_size:
                    if self.parent_product_id.product_tmpl_id.mesh_size > 0 and self.parent_product_id.product_tmpl_id.mesh_size != self.mesh_size:
                        self.mesh_size = 0
                        raise ValidationError("You Cannot change this Product mesh size.")
                else:
                    self.mesh_size = 0
                    # raise ValidationError("This Product doesn't have kg.")


    @api.onchange('hole_diameter')
    def onchange_hole_diameter(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_hole_diameter:
                    if self.parent_product_id.product_tmpl_id.hole_diameter > 0 and self.parent_product_id.product_tmpl_id.hole_diameter != self.hole_diameter:
                        self.hole_diameter = 0
                        raise ValidationError("You Cannot change this Product hole diameter.")
                else:
                    self.hole_diameter = 0
                    # raise ValidationError("This Product doesn't have kg.")
    
    # @api.onchange('number')
    # def onchange_number(self):
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_number:
    #                 if self.parent_product_id.product_tmpl_id.number > 0 and self.parent_product_id.product_tmpl_id.number != self.number:
    #                     self.number = 0
    #                     raise ValidationError("You Cannot change this Product number.")
    #             else:
    #                 self.number = 0
    #                 # raise ValidationError("This Product doesn't have kg.")

    # @api.onchange('opening_dimension')
    # def onchange_opening_dimension(self):
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_opening_dimension:
    #                 if self.parent_product_id.product_tmpl_id.opening_dimension > 0 and self.parent_product_id.product_tmpl_id.opening_dimension != self.opening_dimension:
    #                     self.opening_dimension = 0
    #                     raise ValidationError("You Cannot change this Product opening dimension.")
    #             else:
    #                 self.opening_dimension = 0
    #                 # raise ValidationError("This Product doesn't have kg.")
    
    # @api.onchange('metric_number')
    # def onchange_metric_number(self):
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_metric_number:
    #                 if self.parent_product_id.product_tmpl_id.metric_number > 0 and self.parent_product_id.product_tmpl_id.metric_number != self.metric_number:
    #                     self.metric_number = 0
    #                     raise ValidationError("You Cannot change this Product metric_number.")
    #             else:
    #                 self.metric_number = 0
    #                 # raise ValidationError("This Product doesn't have kg.")
    
    # @api.onchange('size')
    # def onchange_size(self):
    #         if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
    #             if self.parent_product_id.product_tmpl_id.categ_id.is_have_size:
    #                 if self.parent_product_id.product_tmpl_id.size > 0 and self.parent_product_id.product_tmpl_id.size != self.size:
    #                     self.size = 0
    #                     raise ValidationError("You Cannot change this Product size.")
    #             else:
    #                 self.size = 0
    #                 # raise ValidationError("This Product doesn't have kg.")

    @api.onchange('width_2')
    def onchange_width_2(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_width_2:
                    if self.parent_product_id.product_tmpl_id.width_2 > 0 and self.parent_product_id.product_tmpl_id.width_2 != self.width_2:
                        self.width_2 = 0
                        raise ValidationError("You Cannot change this Product width 2.")
                else:
                    self.width_2 = 0
                    # raise ValidationError("This Product doesn't have kg.")

    @api.onchange('pitch')
    def onchange_pitch(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_pitch:
                    if self.parent_product_id.product_tmpl_id.pitch > 0 and self.parent_product_id.product_tmpl_id.pitch != self.pitch:
                        self.pitch = 0
                        raise ValidationError("You Cannot change this Product pitch.")
                else:
                    self.pitch = 0
                    # raise ValidationError("This Product doesn't have kg.")

    @api.onchange('inner_diameter')
    def onchange_inner_diameter(self):
            if self.parent_product_id and self.parent_product_id.product_tmpl_id.categ_id:
                if self.parent_product_id.product_tmpl_id.categ_id.is_have_pitch:
                    if self.parent_product_id.product_tmpl_id.pitch > 0 and self.parent_product_id.product_tmpl_id.inner_diameter != self.inner_diameter:
                        self.inner_diameter = 0
                        raise ValidationError("You Cannot change this Product Inner Diameter.")
                else:
                    self.inner_diameter = 0
                    # raise ValidationError("This Product doesn't have kg.")

    def action_view_custom_stock(self):
        print("Test")

    parent_product_id = fields.Many2one('product.product', string='Parent Product')
    parent_product_categ_id = fields.Many2one('product.category', string='Product Category', related='parent_product_id.categ_id')
    name = fields.Char('Product',related='parent_product_id.product_tmpl_id.name')
    # is_parent_id = fields.Many2one('product.template', string='Cek Product', related='parent_product_id.parent_product_id')
    is_parent_id = fields.Boolean('Have Parent')
    description = fields.Text('Description')

    width = fields.Float('Width')
    length = fields.Float('Length')
    # height = fields.Float('Height')
    diameter = fields.Float('Diameter(OD)')
    thickness = fields.Float('Thickness')
    electrode_number = fields.Char('Electrode Number')
    batch_number = fields.Char('Batch Number')
    kg = fields.Float('Kg')
    # outer_diameter  = fields.Float('Outer Diameter')
    across_flat = fields.Float('Across Flat')
    # breadth = fields.Float('Breadth')
    mesh_number = fields.Float('Mesh Number')
    mesh_size = fields.Float('Mesh Size')
    hole_diameter = fields.Float('Hole Diameter')
    # number = fields.Float('Number')
    # opening_dimension = fields.Float('Opening Dimension')
    # metric_number = fields.Float('Metric Number')
    # size = fields.Float('Size')
    width_2 = fields.Float('Width 2')
    pitch = fields.Float('Pitch')
    inner_diameter = fields.Float('Inner Diameter')
    discount = fields.Float('Discount %')

    master_width = fields.Float('Width')
    master_length = fields.Float('Length')
    # master_height = fields.Float('Height')
    master_diameter = fields.Float('Diameter(OD)')
    master_thickness = fields.Float('Thickness')
    master_kg = fields.Float('Kg')
    # master_outer_diameter  = fields.Float('Outer Diameter')
    master_across_flat = fields.Float('Across Flat')
    # master_breadth = fields.Float('Breadth')
    master_mesh_number = fields.Float('Mesh Number')
    master_mesh_size = fields.Float('Mesh Size')
    master_hole_diameter = fields.Float('Hole Diameter')
    # master_number = fields.Float('Number')
    # master_opening_dimension = fields.Float('Opening Dimension')
    # master_metric_number = fields.Float('Metric Number')
    # master_size = fields.Float('Size')
    master_width_2 = fields.Float('Width 2')
    master_pitch = fields.Float('Pitch')
    master_inner_diameter = fields.Float('inner_diameter')

    order_ids = fields.Many2one('sale.order', string='Order Reference', ondelete='cascade', index=True, copy=False)
    currency_id = fields.Many2one(related='order_ids.currency_id', depends=['order_ids.currency_id'], store=True, string='Currency')
    dimension_uom_id = fields.Many2one('uom.uom', string='Dimension UoM')
    product_uom_id = fields.Many2one('uom.uom', string='UoM')
    unit_price = fields.Float('Unit Price')
    tax_ids = fields.Many2many('account.tax', string='Taxes')
    tax_price = fields.Float('Tax Price', compute='_compute_tax_price')
    child_product = fields.Char('Child Product', compute='_compute_child_product')
    discount = fields.Float(string='Discount (%)', digits='Discount', default=0.0)
    discount_overall = fields.Float('Overall Discount %',related='order_ids.discount_overall')
    quantity = fields.Float('Qty', default=1)
    subtotal = fields.Monetary(compute='_compute_amount',string='Subtotal',store=True,)
    price_total = fields.Float(compute='_compute_amount', string='Total', store=True)
    price_tax = fields.Monetary(compute='_compute_amount', string='Total Tax', store=True)
    
    is_have_diameter = fields.Boolean('Diameter(OD)')
    # is_have_height = fields.Boolean('Height')
    is_have_width = fields.Boolean('Width')
    is_have_thickness = fields.Boolean('Thickness')
    is_have_length = fields.Boolean('Length')
    is_have_kg = fields.Boolean('Kg')
    # is_have_outer_diameter = fields.Boolean('Outer Diameter')
    is_have_across_flat = fields.Boolean('Across Flat')
    # is_have_breadth = fields.Boolean('Breadth')
    is_have_mesh_number = fields.Boolean('Mesh Number')
    is_have_mesh_size = fields.Boolean('Mesh Size')
    is_have_hole_diameter = fields.Boolean('Hole Diameter')
    # is_have_number = fields.Boolean('Number')
    # is_have_opening_dimension = fields.Boolean('Opening Dimension')
    # is_have_metric_number = fields.Boolean('Metric Number')
    # is_have_size = fields.Boolean('Size')
    is_have_width_2 = fields.Boolean('Width 2')
    is_have_pitch = fields.Boolean('Pitch')
    is_have_inner_diameter = fields.Boolean('Inner Diameter')

    notes = fields.Text = fields.Text('Notes')